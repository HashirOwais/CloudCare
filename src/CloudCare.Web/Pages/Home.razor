@page "/"
@attribute [Authorize]
@using CloudCare.Web.Services.Shared
@inject UserService UserService
@inject NavigationManager Navigation
@using System.Web

@if (_isChecking)
{
    <div class="d-flex justify-center align-center" style="min-height: 50vh;">
        <MudProgressCircular Indeterminate="true" />
        <MudText Class="ml-2">Loading...</MudText>
    </div>
}
else
{
    <MudText Typo="Typo.h3" GutterBottom="true">Welcome to CloudCare</MudText>
    <MudText>Your dashboard content goes here...</MudText>
}

@code
{
    private bool _isChecking = true;

    protected override async Task OnInitializedAsync()
    {
        // Check if user just registered (skip profile check)
        var uri = new Uri(Navigation.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);

        if (query["registered"] == "true")
        {
            Console.WriteLine("Index: User just registered, skipping profile check.");
            _isChecking = false;
            return;
        }

        try
        {
            Console.WriteLine("Index: Checking if user profile exists.");
            var userExists = await UserService.UserExistsAsync();

            Console.WriteLine($"Index: User exists: {userExists}");

            if (!userExists)
            {
                Console.WriteLine("Index: Redirecting to create-profile.");
                Navigation.NavigateTo("/create-profile", forceLoad: false);
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking user: {ex.Message}");
        }

        _isChecking = false;
    }
}