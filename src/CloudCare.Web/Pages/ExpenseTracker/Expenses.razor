@page "/expenses"
@using CloudCare.Shared.DTOs.ExpenseTracker
@using CloudCare.Shared.Models
@using CloudCare.Web.Services.ExpenseTracker
@using CloudCare.Web.Services
@using Microsoft.AspNetCore.Authorization
@using CloudCare.Web.Shared
@using CloudCare.Web.Models
@inject NavigationManager NavigationManager
@inject ExpenseStateService ExpenseStateService

@inject ExpenseService ExpenseService
@inject CategoryService CategoryService
@inject VendorService VendorService
@inject PaymentMethodService PaymentMethodService
@inject IDialogService DialogService 
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [Authorize]

<MudDataGrid Items="@_expenses" Filterable="true" Bordered="true">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Expenses</MudText>
        <MudSpacer />
        
        <MudMenu Label="Add Expense" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
            <MudMenuItem Icon="@Icons.Material.Filled.Assignment" OnClick="@(() => NavigationManager.NavigateTo("/expense/add"))">Add Manually</MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.DocumentScanner" OnClick="@AddFromPhotoAsync">Add Expense from photo</MudMenuItem>
        </MudMenu>
    </ToolBarContent>
    
    <Columns>
        <PropertyColumn Property="x => x.Date" />
        <PropertyColumn Property="x => x.Amount" Format="C2" />
        <PropertyColumn Property="x => x.Category" Title="Category" />
        <PropertyColumn Property="x => x.Vendor" Title="Vendor" />
        <PropertyColumn Property="x => x.Description" />
        
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate Context="cellContext">
                <MudIconButton Size="@Size.Small" 
                               Icon="@Icons.Material.Outlined.Edit" 
                               Color="Color.Primary"
                               OnClick="@(() => EditItem(cellContext.Item))" />
                <MudIconButton Size="@Size.Small" 
                               Icon="@Icons.Material.Outlined.Delete" 
                               Color="Color.Error"
                               OnClick="@(() => DeleteItemAsync(cellContext.Item))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    
    <PagerContent>
        <MudDataGridPager />
    </PagerContent>
</MudDataGrid>

@code {
    private List<ReadExpenseDto> _expenses = new();
    private List<Category> _categories = new();
    private List<Vendor> _vendors = new();
    private List<PaymentMethod> _paymentMethods = new();

    protected override async Task OnInitializedAsync()
    {
        _expenses = await ExpenseService.GetExpensesAsync();
        _categories = await CategoryService.GetCategoriesAsync();
        _vendors = await VendorService.GetVendorsAsync();
        _paymentMethods = await PaymentMethodService.GetPaymentMethodsAsync();
    }
    
    private async Task AddFromPhotoAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        

        // Assuming the role claim type is "role". You might need to adjust this.
        //if (user.IsInRole("Pro"))
       // {
            var dialog = await DialogService.ShowAsync<AddFromPhotoDialog>("Add from Photo");
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is ExpenseForCreationDto ocrResult)
            {
                var model = new ExpenseFormModel
                {
                    Description = ocrResult.Description,
                    Amount = ocrResult.Amount,
                    Date = ocrResult.Date,
                    CategoryId = ocrResult.CategoryId,
                    VendorId = ocrResult.VendorId,
                    PaymentMethodId = ocrResult.PaymentMethodId
                };
                ExpenseStateService.SetExpense(model);
                NavigationManager.NavigateTo("/expense/add");
            }
        //}
        //else
        //{
        //    Snackbar.Add("Please upgrade to the Pro plan to use this feature.", Severity.Warning);
       // }
    }

    private void EditItem(ReadExpenseDto item)
    {
        var categoryId = _categories.FirstOrDefault(c => c.Name.Trim().Equals(item.Category.Trim(), StringComparison.OrdinalIgnoreCase))?.Id;
        var vendorId = _vendors.FirstOrDefault(v => v.Name.Trim().Equals(item.Vendor.Trim(), StringComparison.OrdinalIgnoreCase))?.Id;
        var paymentMethodId = _paymentMethods.FirstOrDefault(p => p.Name.Trim().Equals(item.PaymentMethod.Trim(), StringComparison.OrdinalIgnoreCase))?.Id;

        var model = new ExpenseFormModel
        {
            Id = item.Id,
            Description = item.Description,
            Amount = item.Amount,
            Date = item.Date,
            CategoryId = categoryId,
            VendorId = vendorId,
            PaymentMethodId = paymentMethodId
        };
        ExpenseStateService.SetExpense(model);
        NavigationManager.NavigateTo("/expense/add");
    }

    private async Task DeleteItemAsync(ReadExpenseDto item)
    {
        // 1. Show the Message Box
        // Note: Because your MainLayout sets "NoHeader=true", the title "Warning" might not appear.
        // We override that here by passing options if needed, but standard MessageBox usually works fine.
        bool? result = await DialogService.ShowMessageBox(
            "Warning", 
            $"Are you sure you want to delete {item.Description}?", 
            yesText:"Delete!", cancelText:"Cancel");

        // 2. Check Result
        if (result == true)
        {
            try 
            {
                await ExpenseService.DeleteExpenseAsync(item.Id);
                _expenses.Remove(item); // Update UI
                Snackbar.Add("Expense Deleted", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}